<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=0.6">
<title>Mbilse Secure Chat</title>
<style>
body{
  margin:0;
  background:#fff;
  color:#000;
  font-family:Arial;
  display:flex;
  flex-direction:column;
  height:100vh;
}
#header{
  padding:12px;
  background:#EEEEEE;
}
#roomTitle{font-weight:bold;}
#online{font-size:12px;opacity:.6;}
#chat{
  flex:1;
  overflow:auto;
  padding:10px;
}
.msg{
  margin:6px 0;
  padding:8px 12px;
  border-radius:12px;
  max-width:50%;
  word-wrap:break-word;
}
.self{
  background:#DDDDDD;
  margin-left:auto;
}
.other{
  background:#EEEEEE;
}
#inputArea{
  display:flex;
  padding:8px;
  background:#EEEEEE;
}
input,button{
  padding:8px;
  margin:2px;
  border:none;
  border-radius:6px;
}
button{
  background:#4c6ef5;
  color:white;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="header">
  <div id="roomTitle"></div>
  <div id="online"></div>
</div>

<div id="chat"></div>

<div id="inputArea">
  <input id="message" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." style="flex:1;">
  <input type="file" id="fileInput">
  <button id="sendBtn">ÂèëÈÄÅ</button>
</div>

<script type="module">
import { initializeApp } from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot } from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* üî• ÊõøÊç¢Êàê‰Ω†ÁöÑ Firebase ÈÖçÁΩÆ */
const firebaseConfig = {
  apiKey:"AIzaSyAc5XQy1vLmZ0yAuE5_T9zbcFg_VoDdSpI",
  authDomain:"main-project-3b456.firebaseapp.com",
  projectId:"main-project-3b456"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üë§ Âü∫Êú¨‰ø°ÊÅØ */
const roomId = prompt("Áæ§Âêç");
const username = prompt("Áî®Êà∑Âêç");
const password = prompt("Áæ§ÂØÜÈí•(Âª∫ËÆÆ12‰Ωç+)");

document.getElementById("roomTitle").innerText = "Áæ§ËÅä: " + roomId;

/* üîê AES ÂØÜÈí•ÁîüÊàê */
async function deriveKey(pass){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey(
    "raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]
  );

  return crypto.subtle.deriveKey(
    {
      name:"PBKDF2",
      salt:enc.encode("mbilse-secure"),
      iterations:150000,
      hash:"SHA-256"
    },
    baseKey,
    {name:"AES-GCM", length:256},
    false,
    ["encrypt","decrypt"]
  );
}

const aesKey = await deriveKey(password);

/* üîí Âä†ÂØÜ */
async function encrypt(text){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encoded = new TextEncoder().encode(text);
  const cipher = await crypto.subtle.encrypt(
    {name:"AES-GCM", iv},
    aesKey,
    encoded
  );
  return { iv:Array.from(iv), data:Array.from(new Uint8Array(cipher)) };
}

/* üîì Ëß£ÂØÜ */
async function decrypt(payload){
  const iv = new Uint8Array(payload.iv);
  const data = new Uint8Array(payload.data);
  const plain = await crypto.subtle.decrypt(
    {name:"AES-GCM", iv},
    aesKey,
    data
  );
  return new TextDecoder().decode(plain);
}

/* üë• Âú®Á∫ø‰∫∫Êï∞ */
const userRef = doc(db,"rooms",roomId,"users",username);
await setDoc(userRef,{online:true});

onSnapshot(collection(db,"rooms",roomId,"users"), snap=>{
  document.getElementById("online").innerText =
    "Âú®Á∫ø‰∫∫Êï∞: "+snap.size;
});

/* üí¨ ÂèëÈÄÅÊñáÊú¨ */
document.getElementById("sendBtn")
.addEventListener("click", async ()=>{
  const text = document.getElementById("message").value.trim();
  if(!text) return;

  const encrypted = await encrypt(text);

  await addDoc(collection(db,"rooms",roomId,"messages"),{
    sender:username,
    iv:encrypted.iv,
    data:encrypted.data,
    file:false,
    time:Date.now()
  });

  document.getElementById("message").value="";
});

/* üìé Êñá‰ª∂ÂèëÈÄÅ */
document.getElementById("fileInput")
.addEventListener("change", async e=>{
  const file = e.target.files[0];
  if(!file) return;

  if(file.size > 2*1024*1024){
    alert("Êñá‰ª∂Â§™Â§ßÔºàÈôêÂà∂2MBÔºâ");
    return;
  }

  const reader = new FileReader();
  reader.onload = async ()=>{
    const encrypted = await encrypt(reader.result);

    await addDoc(collection(db,"rooms",roomId,"messages"),{
      sender:username,
      iv:encrypted.iv,
      data:encrypted.data,
      file:true,
      filename:file.name,
      time:Date.now()
    });
  };
  reader.readAsDataURL(file);
});

/* üì• ÁõëÂê¨Ê∂àÊÅØ */
onSnapshot(
  collection(db,"rooms",roomId,"messages"),
  async snap=>{
    const chat = document.getElementById("chat");
    chat.innerHTML="";

    const docs = snap.docs.sort(
      (a,b)=>(a.data().time||0)-(b.data().time||0)
    );

    for(const docSnap of docs){
      const data = docSnap.data();
      try{
        const text = await decrypt(data);
        const div = document.createElement("div");
        div.className="msg " + (data.sender===username?"self":"other");

        if(data.file){
          div.innerHTML = `<b>${data.sender}</b><br>
            <a href="${text}" download="${data.filename}">
            ‰∏ãËΩΩÊñá‰ª∂: ${data.filename}</a>`;
        }else{
          div.innerHTML = `<b>${data.sender}</b><br>${text}`;
        }

        chat.appendChild(div);
      }catch(e){
        console.error("Ëß£ÂØÜÂ§±Ë¥•:", e);
      }
    }

    chat.scrollTop = chat.scrollHeight;
  }
);

</script>
</body>
</html>